<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../../04-ingest-pipeline/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.18">
    
    
      
        <title>Instructions - MS Fabric Labs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-03b-create-medallion-architecture-in-a-fabric-lakehouse" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MS Fabric Labs" class="md-header__button md-logo" aria-label="MS Fabric Labs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MS Fabric Labs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Instructions
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MS Fabric Labs" class="md-nav__button md-logo" aria-label="MS Fabric Labs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3C7.58 3 4 4.79 4 7s3.58 4 8 4 8-1.79 8-4-3.58-4-8-4M4 9v3c0 2.21 3.58 4 8 4s8-1.79 8-4V9c0 2.21-3.58 4-8 4s-8-1.79-8-4m0 5v3c0 2.21 3.58 4 8 4s8-1.79 8-4v-3c0 2.21-3.58 4-8 4s-8-1.79-8-4"></path></svg>

    </a>
    MS Fabric Labs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Microsoft Fabric
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Microsoft Fabric
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../01-lakehouse/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    01 Lakehouse
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            01 Lakehouse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../01-lakehouse/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    3b Medallion Architecture
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            3b Medallion Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-access-microsoft-fabric" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Access Microsoft Fabric
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-create-a-workspace" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Create a workspace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-create-a-lakehouse" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create a lakehouse
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-upload-data-to-bronze-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Upload data to bronze layer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-transform-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Transform the data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-6-data-validation-and-cleanup" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Data validation and cleanup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-7-define-the-schema-for-the-silver-table" class="md-nav__link">
    <span class="md-ellipsis">
      Step 7: Define the schema for the silver table
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-8-insert-and-update-records" class="md-nav__link">
    <span class="md-ellipsis">
      Step 8: Insert and update records
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-9-explore-data-in-the-silver-layer-using-the-sql-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Step 9: Explore data in the silver layer using the SQL endpoint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-10-transform-data-for-gold-layer" class="md-nav__link">
    <span class="md-ellipsis">
      Step 10: Transform data for gold layer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-11-create-a-semantic-model" class="md-nav__link">
    <span class="md-ellipsis">
      Step 11: Create a semantic model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-12-create-relationships-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Step 12: Create relationships (optional)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-13-create-a-powerbi-report-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Step 13: Create a PowerBi report (optional)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clean-up-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Clean up resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../04-ingest-pipeline/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    04 Ingest Pipeline
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            04 Ingest Pipeline
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../04-ingest-pipeline/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../05-dataflows-gen2/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    05 Dataflows (Gen2)
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            05 Dataflows (Gen2)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../05-dataflows-gen2/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../06-data-warehouse/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    06 Analyse data in a data warehouse
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            06 Analyse data in a data warehouse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../06-data-warehouse/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../06c-monitor-data-warehouse/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    06c Monitor Data Warehouse
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            06c Monitor Data Warehouse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../06c-monitor-data-warehouse/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../09-real-time-analytics-eventstream/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    09 Real-time Eventstream
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            09 Real-time Eventstream
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../09-real-time-analytics-eventstream/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../11-data-activator/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    11 Data Activator
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            11 Data Activator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../11-data-activator/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../18-monitor-hub/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    18 Monitor Hub
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            18 Monitor Hub
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../18-monitor-hub/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../19-secure-data-access/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    19 Secure Data Access
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            19 Secure Data Access
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../19-secure-data-access/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../20-work-with-database/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    20 Work with SQL Database
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            20 Work with SQL Database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../20-work-with-database/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../21-implement-cicd/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    21 Deployment Pipelines
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            21 Deployment Pipelines
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../21-implement-cicd/instructions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instructions
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="lab-03b-create-medallion-architecture-in-a-fabric-lakehouse">Lab 03b ~ Create Medallion Architecture in a Fabric Lakehouse</h1>
<div class="admonition info">
<p class="admonition-title">For this lab, you will access the QA Platform and sign in using the credentials provided.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">You must use an incognito or private browser window to avoid conflicts with any work or personal Microsoft accounts you may already be signed in to.</p>
</div>
<h2 id="step-1-access-microsoft-fabric">Step 1: Access Microsoft Fabric</h2>
<p>In this lab, you will access Microsoft Fabric using a temporary lab account provided by the QA Platform.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The QA Platform opens the Azure portal by default. This is expected. Microsoft Fabric is a separate portal, even though it uses the same Microsoft account.</p>
</div>
<ol>
<li>
<p>In the QA Platform, wait until the lab status shows <strong>Ready</strong>.</p>
</li>
<li>
<p>Then right-click <strong>Open</strong> and choose <strong>Open in a private browsing window</strong> (InPrivate in Edge, Incognito in Chrome).</p>
</li>
<li>
<p>When prompted, sign in using:</p>
<ul>
<li><strong>Username</strong> from the QA Platform (used as the email address)</li>
<li>
<p><strong>Password</strong> from the QA Platform (used as a Temporary Access Pass)</p>
</li>
<li>
<p>If prompted to "Stay signed in?", select <strong>No</strong>. This ensures the session ends when the private window is closed.</p>
</li>
</ul>
<div class="admonition success">
<p class="admonition-title">You are now signed in to the <strong>Azure portal</strong>. This confirms your lab account is active.</p>
</div>
</li>
<li>
<p>In the same private browsing window, <strong>open a new tab</strong>.</p>
</li>
<li>
<p>Navigate to the <a href="https://app.fabric.microsoft.com">Microsoft Fabric home page</a> at: <a href="https://app.fabric.microsoft.com">https://app.fabric.microsoft.com</a></p>
</li>
<li>
<p>If prompted, <strong>re-enter your email address</strong> to confirm access to Microsoft Fabric. This check verifies that a Fabric licence has been assigned to your lab account.</p>
</li>
<li>
<p>After confirmation, you should be be redirected to the <strong>Microsoft Fabric home page</strong>:</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/qa-fabric-home.png" data-desc-position="bottom"><img alt="Fabric home page" src="../../img/qa-fabric-home.png"></a></p>
</div>
</li>
</ol>
<h2 id="step-2-create-a-workspace">Step 2: Create a workspace</h2>
<p>Before working with data in Fabric, you need to create a workspace.</p>
<ol>
<li>
<p>In the left-hand navigation, select <strong>Workspaces</strong> (the icon looks similar to ðŸ—‡).</p>
</li>
<li>
<p>Select <strong>+ New workspace</strong>, then create a workspace using the naming format below:</p>
<ul>
<li>Start the name with <code>fab_workspace</code></li>
<li>Add random numbers to make it unique (for example, <code>fab_workspace123</code>)</li>
<li>Leave all other options as the default values</li>
<li>Click <strong>Apply</strong></li>
</ul>
</li>
<li>
<p>When your new workspace opens, it should be empty:</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/new-workspace.png" data-desc-position="bottom"><img alt="Empty workspace in Fabric." src="../../img/new-workspace.png"></a></p>
</div>
</li>
</ol>
<h2 id="step-3-create-a-lakehouse">Step 3: Create a lakehouse</h2>
<p>Now that you have a workspace, it's time to create a data lakehouse into which you'll ingest data.</p>
<ol>
<li>
<p>On the menu bar on the left, select <strong>Create</strong>. In the <em>New</em> page, under the <em>Data Engineering</em> section, select <strong>Lakehouse</strong>.</p>
<ul>
<li>Name the lakehouse: <code>Sales</code></li>
<li>Ensure <strong>Lakehouse schemas</strong> is disabled to keep the lakehouse structure consistent with the lab instructions.</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">If the <strong>Create</strong> option is not pinned to the sidebar, you need to select the ellipsis (â€¦) option first.</p>
</div>
<p>After a minute or so, a new empty lakehouse will be created.</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/new-lakehouse.png" data-desc-position="bottom"><img alt="New lakehouse." src="../../img/new-lakehouse.png"></a></p>
</div>
</li>
</ol>
<h2 id="step-4-upload-data-to-bronze-layer">Step 4: Upload data to bronze layer</h2>
<p>Next, you'll ingest some data into the data lakehouse for analysis. There are multiple ways to do this, but in this exercise you'll simply download a text file to your local computer (or lab VM if applicable) and then upload it to your lakehouse.</p>
<ol>
<li>
<p>Download the data file for this exercise from <code>https://github.com/MicrosoftLearning/dp-data/blob/main/orders.zip</code></p>
<ul>
<li>Extract the files and save them with their original names on your local computer (or lab VM if applicable).</li>
</ul>
<div class="admonition success">
<p class="admonition-title">There should be 3 files containing sales data for 3 years: 2019.csv, 2020.csv, and 2021.csv</p>
</div>
</li>
<li>
<p>Return to the web browser tab containing your lakehouse:</p>
<ul>
<li>In the <strong>...</strong> menu for the <strong>Files</strong> folder in the <strong>Explorer</strong> pane, select <strong>New subfolder</strong> and create a folder named <strong>bronze</strong></li>
</ul>
</li>
<li>
<p>In the <strong>...</strong> menu for the <strong>bronze</strong> folder, select <strong>Upload</strong> and <strong>Upload files</strong></p>
<ul>
<li>Then upload the 3 files (2019.csv, 2020.csv, and 2021.csv) from your local computer (or lab VM if applicable) to the lakehouse. </li>
<li>Use the shift key to upload all 3 files at once.</li>
</ul>
</li>
<li>
<p>After the files have been uploaded, select the <strong>bronze</strong> folder; and verify that the files have been uploaded, as shown here:</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/03b-bronze-files.png" data-desc-position="bottom"><img alt="Uploaded products.csv file in a lakehouse." src="../../img/03b-bronze-files.png"></a></p>
</div>
</li>
</ol>
<h2 id="step-5-transform-the-data">Step 5: Transform the data</h2>
<p>Now that you have some data in the bronze layer of your lakehouse, you can use a notebook to transform the data before you load it to a delta table in the silver layer.</p>
<ol>
<li>
<p>On the <strong>Home</strong> page while viewing the contents of the <strong>bronze</strong> folder in your data lake, in the <strong>Open notebook</strong> menu, select <strong>New notebook</strong>.</p>
<div class="admonition info">
<p class="admonition-title">After a few seconds, a new notebook containing a <em>single cell</em> will open.</p>
</div>
</li>
<li>
<p>When the notebook opens, rename it to <code>Transform data for Silver</code> by selecting the <code>Notebook 1</code> text at the top left of the notebook and entering the new name.</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/03b-sales-notebook-rename.png" data-desc-position="bottom"><img alt="New notebook named Transform data for silver." src="../../img/03b-sales-notebook-rename.png"></a></p>
</div>
</li>
<li>
<p>Select the existing cell in the notebook, which contains some simple commented-out code.</p>
<ul>
<li>Highlight and <strong>delete the two lines</strong> - you will not need this code.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>Notebooks enable you to run code in a variety of languages, including Python, Scala, and SQL."</li>
<li>In this exercise, youâ€™ll use PySpark and SQL. </li>
<li>You can also add markdown cells to provide formatted text and images to document your code.</li>
</ul>
</div>
</li>
<li>
<p>Paste the following code into the first cell:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Silver: Cell 1 ~ Transform the data before you load it</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Create the schema for the table</span>
<span class="n">orderSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"SalesOrderNumber"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"SalesOrderLineNumber"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"Email"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"Quantity"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"UnitPrice"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">"Tax"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span>
    <span class="p">])</span>

<span class="c1"># Import all files from bronze folder of lakehouse</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"csv"</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"header"</span><span class="p">,</span> <span class="s2">"false"</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">orderSchema</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"Files/bronze/*.csv"</span><span class="p">)</span>

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
</li>
<li>
<p>Use the <strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7z"></path></svg></span> (Run cell)</strong> button on the left of the cell to run the code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>Since this is the first time you've run any Spark code in this notebook, a Spark session must be started.</li>
<li>This means that the first run can take a minute or so to complete. </li>
<li>Subsequent runs will be quicker.</li>
</ul>
</div>
</li>
<li>
<p>When the cell command has completed, review the output below the cell, which should look similar to this:</p>
<div class="highlight"><pre><span></span><code>| Index | SalesOrderNumber | SalesOrderLineNumber | OrderDate  | CustomerName | Email             | Item                 | Quantity | UnitPrice | Tax      |
| ----- | ---------------- | -------------------- | ---------- | ------------ | ----------------- | -------------------- | -------- | --------- | -------- |
| 1     | SO49172          | 1                    | 2021-01-01 | Brian Howard | brian@example.com | Road-250 Red, 52     | 1        | 2443.35   | 195.468  |
| 2     | SO49173          | 1                    | 2021-01-01 | Linda Alvarez| linda@example.com | Mount-200 Silver, 38 | 1        | 2071.4197 | 165.7136 |
| ...   | ...              | ...                  | ...        | ...          | ...               | ...                  | ...      | ...       | ...      |
</code></pre></div>
<p>The code you ran loaded the data from the CSV files in the bronze folder into a Spark dataframe, and then displayed the first few rows of the dataframe.</p>
<div class="admonition note">
<p class="admonition-title">Note: You can clear, hide, and auto-resize the contents of the cell output by selecting the <strong>...</strong> menu at the top left of the output pane.</p>
</div>
</li>
</ol>
<h2 id="step-6-data-validation-and-cleanup">Step 6: Data validation and cleanup</h2>
<p>Now that you have transformed data, you can use a notebook to load it to a delta table in the silver layer.</p>
<ol>
<li>
<p>Now you'll <strong>add columns for data validation and cleanup</strong>, using a PySpark dataframe to add columns and update the values of some of the existing columns. </p>
<ul>
<li>Use the <strong>+ Code</strong> button to <strong>add a new code block</strong> and add the following code to the cell:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Silver: Cell 2 ~ Add columns for data validation and cleanup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">when</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">,</span> <span class="n">input_file_name</span>

<span class="c1"># Add columns IsFlagged, CreatedTS and ModifiedTS</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"FileName"</span><span class="p">,</span> <span class="n">input_file_name</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"IsFlagged"</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="s1">'2019-08-01'</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"CreatedTS"</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">())</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ModifiedTS"</span><span class="p">,</span> <span class="n">current_timestamp</span><span class="p">())</span>

<span class="c1"># Update CustomerName to "Unknown" if CustomerName null or empty</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">,</span> <span class="n">when</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">)</span><span class="o">==</span><span class="s2">""</span><span class="p">)),</span><span class="n">lit</span><span class="p">(</span><span class="s2">"Unknown"</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">)))</span>
</code></pre></div>
<ul>
<li>The first line of the code imports the necessary functions from PySpark. </li>
<li>You're then adding new columns to the dataframe so you can track the source file name, whether the order was flagged as being a before the fiscal year of interest, and when the row was created and modified.</li>
<li>Finally, you're updating the CustomerName column to "Unknown" if it's null or empty.</li>
</ul>
</li>
<li>
<p>Run the cell to execute the code using the <strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7z"></path></svg></span> (Run cell)</strong> button.</p>
</li>
</ol>
<h2 id="step-7-define-the-schema-for-the-silver-table">Step 7: Define the schema for the silver table</h2>
<ol>
<li>
<p>Next, you'll define the schema for the <strong>sales_silver</strong> table in the sales database using Delta Lake format. Create a new code block and add the following code to the cell:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Silver: Cell 3 ~ Define the schema for the sales_silver table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">DeltaTable</span><span class="o">.</span><span class="n">createIfNotExists</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">tableName</span><span class="p">(</span><span class="s2">"sales.sales_silver"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"SalesOrderNumber"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"SalesOrderLineNumber"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Email"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Quantity"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"UnitPrice"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Tax"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"FileName"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"IsFlagged"</span><span class="p">,</span> <span class="n">BooleanType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"CreatedTS"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"ModifiedTS"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>Run the cell to execute the code using the <strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7z"></path></svg></span> (Run cell)</strong> button.</p>
</li>
<li>
<p>Select the <strong>...</strong> in the Tables section of the Explorer pane and select Refresh. You should now see the new <strong>sales_silver</strong> table listed. The <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1 21h22L12 2"></path></svg></span> (triangle icon) indicates that it's a Delta table.</p>
<div class="admonition note">
<p class="admonition-title">Note: If you don't see the new table, wait a few seconds and then select Refresh again, or refresh the entire browser tab.</p>
</div>
</li>
</ol>
<h2 id="step-8-insert-and-update-records">Step 8: Insert and update records</h2>
<p>Now you're going to perform an upsert operation on a Delta table, updating existing records based on specific conditions and inserting new records when no match is found.</p>
<ol>
<li>
<p>Add a new code block and paste the following code:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Silver: Cell 4 ~ Update existing records and insert new ones based on a condition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">'Tables/sales_silver'</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">df</span>

<span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'silver'</span><span class="p">)</span> \
<span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'updates'</span><span class="p">),</span>
    <span class="s1">'silver.SalesOrderNumber = updates.SalesOrderNumber and silver.OrderDate = updates.OrderDate and silver.CustomerName = updates.CustomerName and silver.Item = updates.Item'</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="s2">"SalesOrderNumber"</span><span class="p">:</span> <span class="s2">"updates.SalesOrderNumber"</span><span class="p">,</span>
    <span class="s2">"SalesOrderLineNumber"</span><span class="p">:</span> <span class="s2">"updates.SalesOrderLineNumber"</span><span class="p">,</span>
    <span class="s2">"OrderDate"</span><span class="p">:</span> <span class="s2">"updates.OrderDate"</span><span class="p">,</span>
    <span class="s2">"CustomerName"</span><span class="p">:</span> <span class="s2">"updates.CustomerName"</span><span class="p">,</span>
    <span class="s2">"Email"</span><span class="p">:</span> <span class="s2">"updates.Email"</span><span class="p">,</span>
    <span class="s2">"Item"</span><span class="p">:</span> <span class="s2">"updates.Item"</span><span class="p">,</span>
    <span class="s2">"Quantity"</span><span class="p">:</span> <span class="s2">"updates.Quantity"</span><span class="p">,</span>
    <span class="s2">"UnitPrice"</span><span class="p">:</span> <span class="s2">"updates.UnitPrice"</span><span class="p">,</span>
    <span class="s2">"Tax"</span><span class="p">:</span> <span class="s2">"updates.Tax"</span><span class="p">,</span>
    <span class="s2">"FileName"</span><span class="p">:</span> <span class="s2">"updates.FileName"</span><span class="p">,</span>
    <span class="s2">"IsFlagged"</span><span class="p">:</span> <span class="s2">"updates.IsFlagged"</span><span class="p">,</span>
    <span class="s2">"CreatedTS"</span><span class="p">:</span> <span class="s2">"updates.CreatedTS"</span><span class="p">,</span>
    <span class="s2">"ModifiedTS"</span><span class="p">:</span> <span class="s2">"updates.ModifiedTS"</span>
    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>Run the cell to execute the code using the <strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7z"></path></svg></span> (Run cell)</strong> button.</p>
<p>This operation is important because it enables you to update existing records in the table based on the values of specific columns, and insert new records when no match is found. This is a common requirement when you're loading data from a source system that may contain updates to existing and new records.</p>
<div class="admonition success">
<p class="admonition-title">You now have data in your silver delta table that is ready for further transformation and modeling.</p>
</div>
</li>
<li>
<p>After running the last cell, select the <strong>Run</strong> tab above the ribbon and then select: <strong>Stop session</strong></p>
<div class="admonition info">
<p class="admonition-title">This stops the compute resource being used by the notebook.</p>
</div>
</li>
</ol>
<h2 id="step-9-explore-data-in-the-silver-layer-using-the-sql-endpoint">Step 9: Explore data in the silver layer using the SQL endpoint</h2>
<p>Now that you have data in your silver layer, you can use the SQL analytics endpoint to explore the data and perform some basic analysis. This is useful if you're familiar with SQL and want to do some basic exploration of your data. In this exercise we're using the SQL endpoint view in Fabric, but you can use other tools like SQL Server Management Studio (SSMS) and Azure Data Explorer.</p>
<ol>
<li>
<p>Navigate back to your workspace and notice that you now have several items listed.</p>
<ul>
<li>Select the <strong>Sales SQL analytics endpoint</strong> to open your lakehouse in the SQL analytics endpoint view.</li>
</ul>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/03b-sql-endpoint-item.png" data-desc-position="bottom"><img alt="SQL endpoint in a lakehouse." src="../../img/03b-sql-endpoint-item.png"></a></p>
</div>
</li>
<li>
<p>Select <strong>New SQL query</strong> from the ribbon, which will open a SQL query editor. Note that you can rename your query using the <strong>...</strong> menu item next to the existing query name in the Explorer pane.</p>
<p>Next, you'll run two sql queries to explore the data.</p>
</li>
<li>
<p>Paste the following query into the query editor and select <strong>Run</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="n">OrderDate</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">Year</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="k">CAST</span><span class="w"> </span><span class="p">(</span><span class="k">SUM</span><span class="p">(</span><span class="n">Quantity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">UnitPrice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Tax</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TotalSales</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sales_silver</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="n">OrderDate</span><span class="p">)</span><span class="w"> </span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="n">OrderDate</span><span class="p">)</span>
</code></pre></div>
<p>This query calculates the total sales for each year in the sales_silver table. Your results should look like this:</p>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/03b-total-sales-sql.png" data-desc-position="bottom"><img alt="Screenshot of the results of a SQL query in a lakehouse." src="../../img/03b-total-sales-sql.png"></a></p>
</div>
</li>
<li>
<p>Next you'll review which customers are purchasing the most (in terms of quantity). Paste the following query into the query editor and select <strong>Run</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">TOP</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">CustomerName</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TotalQuantity</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">sales_silver</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">CustomerName</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">TotalQuantity</span><span class="w"> </span><span class="k">DESC</span>
</code></pre></div>
<p>This query calculates the total quantity of items purchased by each customer in the sales_silver table, and then returns the top 10 customers in terms of quantity.</p>
<div class="admonition note">
<p class="admonition-title">Note: Data exploration at the <strong>Silver layer</strong> is useful for basic analysis ...</p>
<ul>
<li>But you need to transform the data further and model it into a star schema.</li>
<li>This will enable you to do more advanced analysis and reporting.</li>
<li>You'll do that in the next section.</li>
</ul>
</div>
</li>
</ol>
<h2 id="step-10-transform-data-for-gold-layer">Step 10: Transform data for gold layer</h2>
<p>You have successfully taken data from your bronze layer, transformed it, and loaded it into a silver Delta table. </p>
<p>Now you'll use a new notebook to transform the data further, model it into a star schema, and load it into gold Delta tables.</p>
<div class="admonition note">
<p class="admonition-title">Note: You could have done all of this in a single notebook ...</p>
<ul>
<li>But for this exercise you're using separate notebooks</li>
<li>This will better demonstrate the process of transforming data from bronze to silver and then from silver to gold.</li>
<li>And it makes it easier to do debugging, troubleshooting, and for reuse.</li>
</ul>
</div>
<ol>
<li>
<p>Return to the workspace home page and create a new notebook called: <code>Transform data for Gold</code></p>
</li>
<li>
<p>In the Explorer pane, add your <strong>Sales</strong> lakehouse by selecting <strong>Add data items</strong> and then selecting the <strong>Sales</strong> lakehouse you created earlier. You should see the <strong>sales_silver</strong> table listed in the <strong>Tables</strong> section of the explorer pane.</p>
</li>
<li>
<p>In the existing code block, remove the commented text and <strong>add the following code</strong> to load data to your dataframe and start building your star schema:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 1 ~ Load data to the dataframe as a starting point to create the gold layer</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Sales.sales_silver"</span><span class="p">)</span>
</code></pre></div>
<p>Use the <strong><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5.14v14l11-7z"></path></svg></span> (Run cell)</strong> button on the left of the cell to run the code.</p>
<div class="admonition warning">
<p class="admonition-title">If you receive a <code>TooManyRequestsForCapacity</code> error when running the first cell:</p>
<ul>
<li>Make sure you stopped the session previously running in the first notebook.</li>
</ul>
</div>
</li>
<li>
<p><strong>Add a new code block</strong> and paste the following code to create your date dimension table and run it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 2 ~ Create the date dimension table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span><span class="o">*</span>

<span class="c1"># Define the schema for the dimdate_gold table</span>
<span class="n">DeltaTable</span><span class="o">.</span><span class="n">createIfNotExists</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">tableName</span><span class="p">(</span><span class="s2">"sales.dimdate_gold"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Day"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"mmmyyyy"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"yyyymm"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>In a new code block, <strong>add and run the following code</strong> to create a dataframe for your date dimension, <strong>dimdate_gold</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 3 ~ Create dataframe for dimDate_gold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">dayofmonth</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">date_format</span>

<span class="n">dfdimDate_gold</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">([</span><span class="s2">"OrderDate"</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">),</span> \
        <span class="n">dayofmonth</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"Day"</span><span class="p">),</span> \
        <span class="n">month</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"Month"</span><span class="p">),</span> \
        <span class="n">year</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">),</span> \
        <span class="n">date_format</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">),</span> <span class="s2">"MMM-yyyy"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"mmmyyyy"</span><span class="p">),</span> \
        <span class="n">date_format</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">),</span> <span class="s2">"yyyyMM"</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"yyyymm"</span><span class="p">),</span> \
    <span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">)</span>

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dfdimDate_gold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">You're separating the code out into code blocks to understand and watch what's happening in the notebook as you transform the data.</p>
</div>
</li>
<li>
<p>In another new code block, <strong>add and run the following code</strong> to update the date dimension as new data comes in:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 4 ~ Update the date dimension as new data comes in</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">'Tables/dimdate_gold'</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">dfdimDate_gold</span>

<span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'gold'</span><span class="p">)</span> \
<span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'updates'</span><span class="p">),</span>
    <span class="s1">'gold.OrderDate = updates.OrderDate'</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="s2">"OrderDate"</span><span class="p">:</span> <span class="s2">"updates.OrderDate"</span><span class="p">,</span>
    <span class="s2">"Day"</span><span class="p">:</span> <span class="s2">"updates.Day"</span><span class="p">,</span>
    <span class="s2">"Month"</span><span class="p">:</span> <span class="s2">"updates.Month"</span><span class="p">,</span>
    <span class="s2">"Year"</span><span class="p">:</span> <span class="s2">"updates.Year"</span><span class="p">,</span>
    <span class="s2">"mmmyyyy"</span><span class="p">:</span> <span class="s2">"updates.mmmyyyy"</span><span class="p">,</span>
    <span class="s2">"yyyymm"</span><span class="p">:</span> <span class="s2">"updates.yyyymm"</span>
    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">The date dimension is now set up. Now you'll create your customer dimension.</p>
</div>
</li>
<li>
<p>To build out the customer dimension table, <strong>add a new code block</strong>, paste and run the following code:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 5 ~ Build the customer gold dimension table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Create customer_gold dimension delta table</span>
<span class="n">DeltaTable</span><span class="o">.</span><span class="n">createIfNotExists</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">tableName</span><span class="p">(</span><span class="s2">"sales.dimcustomer_gold"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Email"</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"First"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Last"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"CustomerID"</span><span class="p">,</span> <span class="n">LongType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>In a new code block, <strong>add and run the following code</strong> to drop duplicate customers, select specific columns, and split the "CustomerName" column to create "First" and "Last" name columns:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 6 ~ Create customer dimension dataframe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">split</span>

<span class="c1"># Create customer_silver dataframe</span>

<span class="n">dfdimCustomer_silver</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">([</span><span class="s2">"CustomerName"</span><span class="p">,</span><span class="s2">"Email"</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">),</span><span class="n">col</span><span class="p">(</span><span class="s2">"Email"</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"First"</span><span class="p">,</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">),</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"Last"</span><span class="p">,</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerName"</span><span class="p">),</span> <span class="s2">" "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dfdimCustomer_silver</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<p>Here you have created a new DataFrame <code>dfdimCustomer_silver</code> by performing various transformations such as dropping duplicates, selecting specific columns, and splitting the "CustomerName" column to create "First" and "Last" name columns.</p>
<p>The result is a DataFrame with cleaned and structured customer data, including separate "First" and "Last" name columns extracted from the "CustomerName"" column.</p>
</li>
<li>
<p>Next we'll create the ID column for our customers. <strong>In a new code block</strong>, paste and run the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 7 ~ Create customer ID column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">monotonically_increasing_id</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">lit</span>

<span class="n">dfdimCustomer_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Sales.dimCustomer_gold"</span><span class="p">)</span>

<span class="n">MAXCustomerID</span> <span class="o">=</span> <span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"CustomerID"</span><span class="p">)),</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"MAXCustomerID"</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">dfdimCustomer_gold</span> <span class="o">=</span> <span class="n">dfdimCustomer_silver</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfdimCustomer_temp</span><span class="p">,(</span><span class="n">dfdimCustomer_silver</span><span class="o">.</span><span class="n">CustomerName</span> <span class="o">==</span> <span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">CustomerName</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfdimCustomer_silver</span><span class="o">.</span><span class="n">Email</span> <span class="o">==</span> <span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">Email</span><span class="p">),</span> <span class="s2">"left_anti"</span><span class="p">)</span>

<span class="n">dfdimCustomer_gold</span> <span class="o">=</span> <span class="n">dfdimCustomer_gold</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"CustomerID"</span><span class="p">,</span><span class="n">monotonically_increasing_id</span><span class="p">()</span> <span class="o">+</span> <span class="n">MAXCustomerID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dfdimCustomer_gold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<p>Here you're cleaning and transforming customer data (<code>dfdimCustomer_silver</code>) by performing a left anti join to exclude duplicates that already exist in the <code>dimCustomer_gold</code> table, and then generating unique CustomerID values using the <code>monotonically_increasing_id()</code> function.</p>
</li>
<li>
<p>Now you'll ensure that your customer table remains up-to-date as new data comes in.</p>
<p><strong>In a new code block</strong>, paste and run the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 8 ~ Keep the customer table up-to-date as new data comes in</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">'Tables/dimcustomer_gold'</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">dfdimCustomer_gold</span>

<span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'gold'</span><span class="p">)</span> \
<span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'updates'</span><span class="p">),</span>
    <span class="s1">'gold.CustomerName = updates.CustomerName AND gold.Email = updates.Email'</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="s2">"CustomerName"</span><span class="p">:</span> <span class="s2">"updates.CustomerName"</span><span class="p">,</span>
    <span class="s2">"Email"</span><span class="p">:</span> <span class="s2">"updates.Email"</span><span class="p">,</span>
    <span class="s2">"First"</span><span class="p">:</span> <span class="s2">"updates.First"</span><span class="p">,</span>
    <span class="s2">"Last"</span><span class="p">:</span> <span class="s2">"updates.Last"</span><span class="p">,</span>
    <span class="s2">"CustomerID"</span><span class="p">:</span> <span class="s2">"updates.CustomerID"</span>
    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p>Now you'll <strong>repeat those steps to create your product dimension</strong>. </p>
<p><strong>In a new code block</strong>, paste and run the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 9 ~ Create product gold dimension</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">DeltaTable</span><span class="o">.</span><span class="n">createIfNotExists</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">tableName</span><span class="p">(</span><span class="s2">"sales.dimproduct_gold"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"ItemName"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"ItemID"</span><span class="p">,</span> <span class="n">LongType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"ItemInfo"</span><span class="p">,</span> <span class="n">StringType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><strong>Add another code block</strong> to create the <strong>product_silver</strong> dataframe.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 10 ~  Create the product_silver dataframe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">when</span>

<span class="n">dfdimProduct_silver</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">([</span><span class="s2">"Item"</span><span class="p">])</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ItemName"</span><span class="p">,</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ItemInfo"</span><span class="p">,</span><span class="n">when</span><span class="p">((</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s2">""</span><span class="p">)),</span><span class="n">lit</span><span class="p">(</span><span class="s2">""</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> 

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dfdimProduct_silver</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
</li>
<li>
<p>Now you'll create IDs for your <strong>dimProduct_gold table</strong>. </p>
<p>Add the following syntax to a new code block and run it:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 11 ~ Create IDs for dimProduct_gold table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">monotonically_increasing_id</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">coalesce</span>

<span class="n">dfdimProduct_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Sales.dimProduct_gold"</span><span class="p">)</span>

<span class="n">MAXProductID</span> <span class="o">=</span> <span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"ItemID"</span><span class="p">)),</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"MAXItemID"</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">dfdimProduct_gold</span> <span class="o">=</span> <span class="n">dfdimProduct_silver</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfdimProduct_temp</span><span class="p">,(</span><span class="n">dfdimProduct_silver</span><span class="o">.</span><span class="n">ItemName</span> <span class="o">==</span> <span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">ItemName</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfdimProduct_silver</span><span class="o">.</span><span class="n">ItemInfo</span> <span class="o">==</span> <span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">ItemInfo</span><span class="p">),</span> <span class="s2">"left_anti"</span><span class="p">)</span>

<span class="n">dfdimProduct_gold</span> <span class="o">=</span> <span class="n">dfdimProduct_gold</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ItemID"</span><span class="p">,</span><span class="n">monotonically_increasing_id</span><span class="p">()</span> <span class="o">+</span> <span class="n">MAXProductID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dfdimProduct_gold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
<p>This calculates the next available product ID based on the current data in the table, assigns these new IDs to the products, and then displays the updated product information.</p>
</li>
<li>
<p>Similar to what you've done with your other dimensions, you need to ensure that your product table remains up-to-date as new data comes in.</p>
<p><strong>In a new code block</strong>, paste and run the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 12 ~ Ensure that your product table remains up-to-date</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">'Tables/dimproduct_gold'</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">dfdimProduct_gold</span>

<span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'gold'</span><span class="p">)</span> \
<span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'updates'</span><span class="p">),</span>
    <span class="s1">'gold.ItemName = updates.ItemName AND gold.ItemInfo = updates.ItemInfo'</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">)</span> \
    <span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="s2">"ItemName"</span><span class="p">:</span> <span class="s2">"updates.ItemName"</span><span class="p">,</span>
    <span class="s2">"ItemInfo"</span><span class="p">:</span> <span class="s2">"updates.ItemInfo"</span><span class="p">,</span>
    <span class="s2">"ItemID"</span><span class="p">:</span> <span class="s2">"updates.ItemID"</span>
    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
<p>Now that you have your dimensions built out, the final step is to create the fact table.</p>
</li>
<li>
<p>In a new code block, paste and run the following code to <strong>create the fact table</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 13 ~ Create the fact table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">DeltaTable</span><span class="o">.</span><span class="n">createIfNotExists</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">tableName</span><span class="p">(</span><span class="s2">"sales.factsales_gold"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"CustomerID"</span><span class="p">,</span> <span class="n">LongType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"ItemID"</span><span class="p">,</span> <span class="n">LongType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"OrderDate"</span><span class="p">,</span> <span class="n">DateType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Quantity"</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"UnitPrice"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">addColumn</span><span class="p">(</span><span class="s2">"Tax"</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><strong>In a new code block</strong>, paste and run the following code to create a <strong>new dataframe</strong> to combine sales data with customer and product information include customer ID, item ID, order date, quantity, unit price, and tax:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 14 ~ Combine sales data with customer and product information</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">col</span>

<span class="n">dfdimCustomer_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Sales.dimCustomer_gold"</span><span class="p">)</span>
<span class="n">dfdimProduct_temp</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"Sales.dimProduct_gold"</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ItemName"</span><span class="p">,</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"ItemInfo"</span><span class="p">,</span><span class="n">when</span><span class="p">((</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span> <span class="o">|</span> <span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s2">""</span><span class="p">)),</span><span class="n">lit</span><span class="p">(</span><span class="s2">""</span><span class="p">))</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"Item"</span><span class="p">),</span> <span class="s2">", "</span><span class="p">)</span><span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> \

<span class="c1"># Create Sales_gold dataframe</span>

<span class="n">dffactSales_gold</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"df1"</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"df2"</span><span class="p">),(</span><span class="n">df</span><span class="o">.</span><span class="n">CustomerName</span> <span class="o">==</span> <span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">CustomerName</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Email</span> <span class="o">==</span> <span class="n">dfdimCustomer_temp</span><span class="o">.</span><span class="n">Email</span><span class="p">),</span> <span class="s2">"left"</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">"df3"</span><span class="p">),(</span><span class="n">df</span><span class="o">.</span><span class="n">ItemName</span> <span class="o">==</span> <span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">ItemName</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ItemInfo</span> <span class="o">==</span> <span class="n">dfdimProduct_temp</span><span class="o">.</span><span class="n">ItemInfo</span><span class="p">),</span> <span class="s2">"left"</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"df2.CustomerID"</span><span class="p">)</span> \
        <span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df3.ItemID"</span><span class="p">)</span> \
        <span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df1.OrderDate"</span><span class="p">)</span> \
        <span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df1.Quantity"</span><span class="p">)</span> \
        <span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df1.UnitPrice"</span><span class="p">)</span> \
        <span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df1.Tax"</span><span class="p">)</span> \
    <span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"df1.OrderDate"</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df2.CustomerID"</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">"df3.ItemID"</span><span class="p">))</span>

<span class="c1"># Display the first 10 rows of the dataframe to preview your data</span>

<span class="n">display</span><span class="p">(</span><span class="n">dffactSales_gold</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>
</li>
<li>
<p>Now you'll ensure that sales data remains up-to-date by running the following code in a <strong>new code block</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Gold: Cell 15 ~ Ensure that sales data remains up-to-date</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">delta.tables</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTable</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">'Tables/factsales_gold'</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">dffactSales_gold</span>

<span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'gold'</span><span class="p">)</span> \
<span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">'updates'</span><span class="p">),</span>
    <span class="s1">'gold.OrderDate = updates.OrderDate AND gold.CustomerID = updates.CustomerID AND gold.ItemID = updates.ItemID'</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>

    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="s2">"CustomerID"</span><span class="p">:</span> <span class="s2">"updates.CustomerID"</span><span class="p">,</span>
    <span class="s2">"ItemID"</span><span class="p">:</span> <span class="s2">"updates.ItemID"</span><span class="p">,</span>
    <span class="s2">"OrderDate"</span><span class="p">:</span> <span class="s2">"updates.OrderDate"</span><span class="p">,</span>
    <span class="s2">"Quantity"</span><span class="p">:</span> <span class="s2">"updates.Quantity"</span><span class="p">,</span>
    <span class="s2">"UnitPrice"</span><span class="p">:</span> <span class="s2">"updates.UnitPrice"</span><span class="p">,</span>
    <span class="s2">"Tax"</span><span class="p">:</span> <span class="s2">"updates.Tax"</span>
    <span class="p">}</span>
<span class="p">)</span> \
<span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
<p>Here you're using Delta Lake's merge operation to synchronize and update the factsales_gold table with new sales data (<code>dffactSales_gold</code>). The operation compares the order date, customer ID, and item ID between the existing data (silver table) and the new data (updates DataFrame), updating matching records and inserting new records as needed.</p>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">You now have a curated, modeled <strong>gold</strong> layer that can be used for reporting and analysis.</p>
</div>
<h2 id="step-11-create-a-semantic-model">Step 11: Create a semantic model</h2>
<p>In your workspace, you can now use the gold layer to create a report and analyze the data. You can access the semantic model directly in your workspace to create relationships and measures for reporting.</p>
<p>Note that you can't use the <strong>default semantic model</strong> that is automatically created when you create a lakehouse. You must create a new semantic model that includes the gold tables you created in this exercise, from the Explorer.</p>
<ol>
<li>
<p>In your workspace, navigate to your <strong>Sales</strong> lakehouse.</p>
</li>
<li>
<p>Select <strong>New semantic model</strong> from the ribbon of the Explorer view.</p>
</li>
<li>
<p>Assign the name <strong>Sales_Gold</strong> to your new semantic model.</p>
</li>
<li>
<p>Select your transformed gold tables to include in your semantic model and select <strong>Confirm</strong>.</p>
<ul>
<li>dimcustomer_gold</li>
<li>dimdate_gold</li>
<li>dimproduct_gold</li>
<li>factsales_gold</li>
</ul>
<p>This will open the semantic model in Fabric.</p>
</li>
</ol>
<h2 id="step-12-create-relationships-optional">Step 12: Create relationships (optional)</h2>
<div class="admonition note">
<p class="admonition-title">Before you can create relationships in a semantic model, you need to have a PowerBI Pro licence</p>
</div>
<div class="admonition info">
<p class="admonition-title">Get a PowerBi licence:</p>
<ul>
<li>Click your Workspace</li>
<li>In the lakehouse row - hover over semantic model</li>
<li>Click the 3 dots <strong>...</strong></li>
<li>Click <strong>Create report</strong></li>
</ul>
</div>
<div class="admonition success">
<p class="admonition-title">A message box should popup offering you a PowerBi Pro trial.</p>
</div>
<ol>
<li>
<p>Before you can make any changes you need to change to Editing mode:</p>
<ul>
<li>In the top right hand corner, change the dropdown from <strong>Viewing</strong> to <strong>Editing</strong></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">You should now be able to create the semantic model as depicted below</p>
</div>
<ol>
<li>
<p>Create the following relationships:</p>
<ul>
<li><strong>dimcustomer_gold: CustomerID</strong> â†’ <strong>factsales_gold: CustomerID</strong></li>
<li><strong>dimdate_gold: OrderDate</strong> â†’ <strong>factsales_gold: OrderDate</strong></li>
<li><strong>dimproduct_gold: ItemID</strong> â†’ <strong>factsales_gold: ItemID</strong></li>
</ul>
</li>
</ol>
<div class="admonition quote">
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../../img/03b-dataset-relationships.png" data-desc-position="bottom"><img alt="Semantic model in Fabric." src="../../img/03b-dataset-relationships.png"></a></p>
</div>
<h2 id="step-13-create-a-powerbi-report-optional">Step 13: Create a PowerBi report (optional)</h2>
<ul>
<li>You can now create new report</li>
<li>Or just auto create a report: <strong>Explore &gt; Auto create report</strong></li>
</ul>
<p>From here you can create reports and dashboards based on the data in your lakehouse. These reports will be connected directly to the gold layer of your lakehouse, so they'll always reflect the latest data.</p>
<hr>
<h2 id="clean-up-resources">Clean up resources</h2>
<p>In this exercise, you've learned how to create a medallion architecture in a Microsoft Fabric lakehouse.</p>
<p>If you've finished exploring the medallion architecture, you can delete the workspace you created for this exercise.</p>
<ol>
<li>
<p>Navigate to Microsoft Fabric in your browser.</p>
</li>
<li>
<p>In the bar on the left, select the icon for your workspace to view all of the items it contains.</p>
</li>
<li>
<p>Select <strong>Workspace settings</strong> and in the <strong>General</strong> section, scroll down and select <strong>Remove this workspace</strong>.</p>
</li>
<li>
<p>Select <strong>Delete</strong> to delete the workspace.</p>
</li>
</ol>
<hr>
<p><small><b>Source:
<a href="https://microsoftlearning.github.io/mslearn-fabric/Instructions/Labs/03b-medallion-lakehouse.html">https://microsoftlearning.github.io/mslearn-fabric/Instructions/Labs/03b-medallion-lakehouse.html</a>
</b></small></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "content.code.copy", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>